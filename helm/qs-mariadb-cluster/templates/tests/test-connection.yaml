{{- $mariadbCluster := index .Values "mariadb-cluster" }}
{{- if and $mariadbCluster.databases $mariadbCluster.users }}
---
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "qs-mariadb-cluster.fullname" . }}-test-connection
  labels:
    {{- include "qs-mariadb-cluster.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "1"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
    - name: test-connection
      image: {{ if .Values.tests }}{{ .Values.tests.image | default "mariadb:11.8" }}{{ else }}mariadb:11.8{{ end }}
      imagePullPolicy: IfNotPresent
      env:
        - name: CLUSTER_NAME
          value: {{ include "qs-mariadb-cluster.fullname" . | quote }}
        - name: MARIADB_HOST
          value: {{ include "qs-mariadb-cluster.fullname" . | quote }}
      command:
        - /bin/bash
        - -c
        - |
          set -e

          echo "════════════════════════════════════════════════════════════════"
          echo "  MariaDB Database Connection Test"
          echo "  Cluster: ${CLUSTER_NAME}"
          echo "════════════════════════════════════════════════════════════════"
          echo
          echo "  Testing using configured endpoints from secrets"
          echo "  (Each user's secret contains the connection details)"
          echo

          FAILED_TESTS=0
          PASSED_TESTS=0

          # Create a map of user to database
          declare -A user_db_map
          {{- range $mariadbCluster.users }}
          user_db_map["{{ .name }}"]="{{ .name }}"
          {{- end }}

          # Test each database/user combination
          {{- range $mariadbCluster.databases }}
          {{- $dbName := .name }}
          {{- $userName := .name }}
          echo "────────────────────────────────────────────────────────────────"
          echo "Testing Database: {{ $dbName }}"
          echo "────────────────────────────────────────────────────────────────"

            # Get connection info and credentials from secret
            SECRET_NAME="qs-postgresql-cluster-access-{{ $userName }}"
            if [ ! -f "/secrets/{{ $userName }}/host" ]; then
              echo "❌ FAIL: Secret not found for user {{ $userName }}"
              FAILED_TESTS=$((FAILED_TESTS + 1))
              continue
            fi

            MARIADB_HOST=$(cat /secrets/{{ $userName }}/host)
            MARIADB_PASSWORD=$(cat /secrets/{{ $userName }}/password)
            MARIADB_PORT=$(cat /secrets/{{ $userName }}/port 2>/dev/null || echo "3306")
            export MARIADB_HOST
            export MARIADB_PASSWORD
            export MARIADB_PORT
            export MARIADB_DATABASE="{{ $dbName }}"
            export MARIADB_USER="{{ $userName }}"

            echo "  Connection: Direct Cluster"
            echo "  Host: $MARIADB_HOST"
            echo "  Port: $MARIADB_PORT"
            echo "  User: $MARIADB_USER"
            echo "  Database: $MARIADB_DATABASE"
            echo

            # Wait for connection endpoint to be ready
            echo -n "  Checking endpoint availability... "
            MAX_RETRIES=30
            RETRY=0
            until mariadb-admin -h "$MARIADB_HOST" -P "$MARIADB_PORT" -u root ping 2>/dev/null || [ $RETRY -eq $MAX_RETRIES ]; do
              RETRY=$((RETRY+1))
              if [ $RETRY -eq $MAX_RETRIES ]; then
                echo "❌ FAIL (timeout)"
                echo "     Connection endpoint not ready after $MAX_RETRIES attempts"
                FAILED_TESTS=$((FAILED_TESTS + 1))
                continue 2  # Skip to next database
              fi
              sleep 2
            done
            echo "✅ PASS"

            # Test 1: Basic connectivity
            echo -n "  Test 1: Basic connectivity... "
            if mariadb -h "$MARIADB_HOST" -P "$MARIADB_PORT" -u "$MARIADB_USER" -p"$MARIADB_PASSWORD" -e "SELECT 1;" > /dev/null 2>&1; then
              echo "✅ PASS"
              PASSED_TESTS=$((PASSED_TESTS + 1))
            else
              echo "❌ FAIL"
              FAILED_TESTS=$((FAILED_TESTS + 1))
            fi

            # Test 2: Current user and database verification
            echo -n "  Test 2: User and database verification... "
            RESULT=$(mariadb -h "$MARIADB_HOST" -P "$MARIADB_PORT" -u "$MARIADB_USER" -p"$MARIADB_PASSWORD" -D "$MARIADB_DATABASE" -e "SELECT USER(), DATABASE();" 2>&1 | tail -n 1)
            if echo "$RESULT" | grep -q "{{ $userName }}"; then
              echo "✅ PASS"
              PASSED_TESTS=$((PASSED_TESTS + 1))
            else
              echo "❌ FAIL"
              echo "     Result: $RESULT"
              FAILED_TESTS=$((FAILED_TESTS + 1))
            fi

            # Test 3: Database exists and is accessible
            echo -n "  Test 3: Database access... "
            if mariadb -h "$MARIADB_HOST" -P "$MARIADB_PORT" -u "$MARIADB_USER" -p"$MARIADB_PASSWORD" -D "$MARIADB_DATABASE" -e "SHOW TABLES;" > /dev/null 2>&1; then
              echo "✅ PASS"
              PASSED_TESTS=$((PASSED_TESTS + 1))
            else
              echo "❌ FAIL"
              FAILED_TESTS=$((FAILED_TESTS + 1))
            fi

            # Test 4: Query execution
            echo -n "  Test 4: Query execution... "
            RESULT=$(mariadb -h "$MARIADB_HOST" -P "$MARIADB_PORT" -u "$MARIADB_USER" -p"$MARIADB_PASSWORD" -D "$MARIADB_DATABASE" -e "SELECT 42;" 2>&1 | tail -n 1 | xargs)
            if [ "$RESULT" = "42" ]; then
              echo "✅ PASS"
              PASSED_TESTS=$((PASSED_TESTS + 1))
            else
              echo "❌ FAIL (expected: 42, got: $RESULT)"
              FAILED_TESTS=$((FAILED_TESTS + 1))
            fi

            # Test 5: Write operations
            echo -n "  Test 5: Write operations... "
            if mariadb -h "$MARIADB_HOST" -P "$MARIADB_PORT" -u "$MARIADB_USER" -p"$MARIADB_PASSWORD" -D "$MARIADB_DATABASE" -e "CREATE TEMPORARY TABLE helm_test (id INT AUTO_INCREMENT PRIMARY KEY, data VARCHAR(255)); INSERT INTO helm_test (data) VALUES ('test'); SELECT COUNT(*) FROM helm_test;" > /dev/null 2>&1; then
              echo "✅ PASS"
              PASSED_TESTS=$((PASSED_TESTS + 1))
            else
              echo "❌ FAIL"
              FAILED_TESTS=$((FAILED_TESTS + 1))
            fi

            # Test 6: User privileges verification
            echo -n "  Test 6: User privileges... "
            RESULT=$(mariadb -h "$MARIADB_HOST" -P "$MARIADB_PORT" -u "$MARIADB_USER" -p"$MARIADB_PASSWORD" -D "$MARIADB_DATABASE" -e "SHOW GRANTS FOR CURRENT_USER();" 2>&1 | grep -i "ALL PRIVILEGES\|GRANT" | head -1)
            if [ -n "$RESULT" ]; then
              echo "✅ PASS"
              PASSED_TESTS=$((PASSED_TESTS + 1))
            else
              echo "❌ FAIL"
              FAILED_TESTS=$((FAILED_TESTS + 1))
            fi

            echo
          {{- end }}

          echo "════════════════════════════════════════════════════════════════"
          echo "  Test Summary"
          echo "════════════════════════════════════════════════════════════════"
          echo "  Cluster: ${CLUSTER_NAME}"
          echo "  Databases Tested: {{ len $mariadbCluster.databases }}"
          echo "  Tests Passed: $PASSED_TESTS"
          echo "  Tests Failed: $FAILED_TESTS"
          echo ""
          echo "  Note: Each database tested using its configured user"
          echo "        and connection details from the secret."
          echo "════════════════════════════════════════════════════════════════"

          if [ $FAILED_TESTS -gt 0 ]; then
            echo
            echo "❌ Some tests failed"
            exit 1
          fi

          echo
          echo "✅ All tests passed successfully!"
          echo "✅ All databases accessible via their configured users"
          exit 0
      volumeMounts:
        {{- range $mariadbCluster.users }}
        - name: secret-{{ .name }}
          mountPath: /secrets/{{ .name }}
          readOnly: true
        {{- end }}
  volumes:
    {{- range $mariadbCluster.users }}
    - name: secret-{{ .name }}
      secret:
        secretName: qs-postgresql-cluster-access-{{ .name }}
        items:
          - key: password
            path: password
          - key: host
            path: host
          - key: port
            path: port
    {{- end }}
{{- end }}

