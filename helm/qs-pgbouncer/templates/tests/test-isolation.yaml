{{- $instances := list }}
{{- if and (hasKey .Values "pgbouncerPharia") (.Values.pgbouncerPharia.enabled) }}
{{- $instances = append $instances (dict "name" "pharia" "values" .Values.pgbouncerPharia "fullname" .Values.pgbouncerPharia.fullnameOverride) }}
{{- end }}
{{- if and (hasKey .Values "pgbouncerTemporal") (.Values.pgbouncerTemporal.enabled) }}
{{- $instances = append $instances (dict "name" "temporal" "values" .Values.pgbouncerTemporal "fullname" .Values.pgbouncerTemporal.fullnameOverride) }}
{{- end }}
{{- range $instance := $instances }}
---
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "qs-pgbouncer.fullname" $ }}-test-isolation-{{ $instance.name }}
  labels:
    {{- include "qs-pgbouncer.labels" $ | nindent 4 }}
    app.kubernetes.io/component: test-isolation
    instance: {{ $instance.name }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
    - name: test-isolation
      image: {{ $.Values.tests.image | default "postgres:17" }}
      imagePullPolicy: IfNotPresent
      env:
        - name: PGHOST
          value: "{{ $instance.fullname }}"
        - name: PGPORT
          value: "5432"
        - name: PGSSLMODE
          value: {{ $.Values.tests.sslMode | default "prefer" | quote }}
        - name: PGCONNECT_TIMEOUT
          value: "3"
      command:
        - /bin/bash
        - -c
        - |
          set -e

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  PgBouncer Database Isolation Test"
          echo "  Instance: {{ $instance.name }}"
          echo "  Service: {{ $instance.fullname }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo

          # Function to convert username to database name
          get_dbname() {
            local username=$1
            if [[ "$username" == *"_"* ]]; then
              echo "$username" | sed 's/_/-/g' | sed 's/-db$//'
            else
              echo "$username"
            fi
          }

          # Wait for PgBouncer to be ready
          echo "â³ Waiting for PgBouncer to be ready..."
          MAX_RETRIES=30
          RETRY=0
          until pg_isready -h $PGHOST -p $PGPORT || [ $RETRY -eq $MAX_RETRIES ]; do
            echo "   Waiting... (attempt $((RETRY+1))/$MAX_RETRIES)"
            sleep 5
            RETRY=$((RETRY+1))
          done

          if [ $RETRY -eq $MAX_RETRIES ]; then
            echo "âŒ ERROR: PgBouncer did not become ready in time"
            exit 1
          fi
          echo "âœ… PgBouncer is ready"
          echo

          FAILED_TESTS=0
          PASSED_TESTS=0

          # Check if userlist.txt exists
          if [ ! -f /secrets/userlist/userlist.txt ]; then
            echo "âŒ ERROR: userlist.txt not found"
            exit 1
          fi

          echo "ğŸ“‹ Building user list..."

          # Read all users into arrays (excluding pgbouncer admin)
          USERS=()
          PASSWORDS=()
          DATABASES=()

          while IFS= read -r line; do
            [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue

            if [[ $line =~ ^\"([^\"]+)\"[[:space:]]+\"([^\"]+)\" ]]; then
              USERNAME="${BASH_REMATCH[1]}"
              PASSWORD="${BASH_REMATCH[2]}"

              if [ "$USERNAME" != "pgbouncer" ]; then
                DBNAME=$(get_dbname "$USERNAME")
                USERS+=("$USERNAME")
                PASSWORDS+=("$PASSWORD")
                DATABASES+=("$DBNAME")
              fi
            fi
          done < /secrets/userlist/userlist.txt

          TOTAL_USERS=${#USERS[@]}

          if [ $TOTAL_USERS -lt 2 ]; then
            echo "â„¹ï¸  Only $TOTAL_USERS user(s) found - isolation testing requires at least 2 users"
            echo "âœ… Test skipped (not applicable)"
            exit 0
          fi

          echo "Found $TOTAL_USERS users for isolation testing"
          echo

          # Test each user trying to access other databases
          for i in "${!USERS[@]}"; do
            USER="${USERS[$i]}"
            PASS="${PASSWORDS[$i]}"
            OWN_DB="${DATABASES[$i]}"

            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo "Testing user: $USER"
            echo "Own database: $OWN_DB"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

            # Test 1: Can access own database
            echo -n "  Test: Access own database... "
            if PGPASSWORD="$PASS" psql -U "$USER" -d "$OWN_DB" -c "SELECT 1;" > /dev/null 2>&1; then
              echo "âœ… PASS"
              PASSED_TESTS=$((PASSED_TESTS + 1))
            else
              echo "âŒ FAIL (cannot access own database!)"
              FAILED_TESTS=$((FAILED_TESTS + 1))
            fi

            # Test 2: Cannot access other databases
            CROSS_ACCESS_TESTS=0
            for j in "${!USERS[@]}"; do
              if [ $i -ne $j ]; then
                OTHER_DB="${DATABASES[$j]}"
                echo -n "  Test: Cross-access to $OTHER_DB... "

                OUTPUT=$(PGPASSWORD="$PASS" psql -U "$USER" -d "$OTHER_DB" -c "SELECT 1;" 2>&1 || true)

                if echo "$OUTPUT" | grep -qE "FATAL|ERROR|permission denied"; then
                  echo "âœ… PASS (access denied)"
                  PASSED_TESTS=$((PASSED_TESTS + 1))
                else
                  echo "âŒ FAIL (access granted - SECURITY ISSUE!)"
                  FAILED_TESTS=$((FAILED_TESTS + 1))
                fi

                CROSS_ACCESS_TESTS=$((CROSS_ACCESS_TESTS + 1))

                # Only test first 2 cross-access attempts to keep test concise
                if [ $CROSS_ACCESS_TESTS -ge 2 ]; then
                  break
                fi
              fi
            done

            echo
          done

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Isolation Test Summary"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Instance: {{ $instance.name }}"
          echo "  Users Tested: $TOTAL_USERS"
          echo "  Tests Passed: $PASSED_TESTS"
          echo "  Tests Failed: $FAILED_TESTS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          if [ $FAILED_TESTS -gt 0 ]; then
            echo
            echo "âŒ Database isolation is NOT properly enforced!"
            echo "âš ï¸  Users can access databases they don't own."
            exit 1
          fi

          echo
          echo "âœ… Database isolation is properly enforced!"
          echo "ğŸ”’ Users can only access their own databases."
          exit 0
      volumeMounts:
        - name: userlist
          mountPath: /secrets/userlist
          readOnly: true
  volumes:
    - name: userlist
      secret:
        secretName: {{ $instance.fullname }}-userlist
{{- end }}

