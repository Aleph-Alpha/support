{{- if .Values.clusterPharia.enabled }}
---
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "qs-postgresql-cluster.fullname" . }}-test-pharia
  labels:
    {{- include "qs-postgresql-cluster.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
    cluster: pharia
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
    - name: test-connection
      image: {{ .Values.tests.image | default "postgres:17" }}
      imagePullPolicy: IfNotPresent
      env:
        - name: PGHOST
          value: "{{ .Values.clusterPharia.fullnameOverride }}-rw"
        - name: PGSSLMODE
          value: {{ .Values.tests.sslMode | default "prefer" | quote }}
      command:
        - /bin/bash
        - -c
        - |
          set -e

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  PostgreSQL Cluster Connection Test"
          echo "  Cluster: Pharia"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo

          # Function to wait for a service to be ready
          wait_for_service() {
            local host=$1
            local description=$2
            
            echo "â³ Waiting for $description to be ready..."
            MAX_RETRIES=30
            RETRY=0
            until pg_isready -h "$host" -U postgres 2>/dev/null || [ $RETRY -eq $MAX_RETRIES ]; do
              echo "   Waiting... (attempt $((RETRY+1))/$MAX_RETRIES)"
              sleep 5
              RETRY=$((RETRY+1))
            done

            if [ $RETRY -eq $MAX_RETRIES ]; then
              echo "âŒ ERROR: $description did not become ready in time"
              return 1
            fi
            echo "âœ… $description is ready"
            return 0
          }

          # Function to run connection tests
          run_tests() {
            local host=$1
            local connection_type=$2
            local user=$3
            local password=$4
            local tests_passed=0
            local tests_failed=0
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "  Connection: $connection_type"
            echo "  Host: $host"
            echo "  User: $user"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Test 1: Basic connectivity
            echo -n "  Test 1: Basic connectivity... "
            if PGPASSWORD="$password" psql -h "$host" -U "$user" -d postgres -c "SELECT 1;" > /dev/null 2>&1; then
              echo "âœ… PASS"
              tests_passed=$((tests_passed + 1))
            else
              echo "âŒ FAIL"
              tests_failed=$((tests_failed + 1))
            fi

            # Test 2: Current user verification
            echo -n "  Test 2: User verification... "
            RESULT=$(PGPASSWORD="$password" psql -h "$host" -U "$user" -d postgres -t -c "SELECT current_user;" 2>&1 | xargs)
            if [ "$RESULT" = "$user" ]; then
              echo "âœ… PASS"
              tests_passed=$((tests_passed + 1))
            else
              echo "âŒ FAIL (expected: $user, got: $RESULT)"
              tests_failed=$((tests_failed + 1))
            fi

            # Test 3: Query execution
            echo -n "  Test 3: Query execution... "
            RESULT=$(PGPASSWORD="$password" psql -h "$host" -U "$user" -d postgres -t -c "SELECT 42;" 2>&1 | xargs)
            if [ "$RESULT" = "42" ]; then
              echo "âœ… PASS"
              tests_passed=$((tests_passed + 1))
            else
              echo "âŒ FAIL"
              tests_failed=$((tests_failed + 1))
            fi
            
            echo "  Summary: $tests_passed passed, $tests_failed failed"
            echo
            
            return $tests_failed
          }

          # Function to get expected host for a role based on config
          get_expected_host_pharia() {
            local role=$1
            local cluster_host="{{ .Values.clusterPharia.fullnameOverride }}-rw"
            local default_pooler="{{ .Values.clusterPharia.config.defaultPooler | default "" }}"
            
            # Check for specific mapping first
            {{- if $.Values.clusterPharia.config }}
            {{- if $.Values.clusterPharia.config.rolePoolerMappings }}
            {{- range $role, $pooler := $.Values.clusterPharia.config.rolePoolerMappings }}
            if [ "$role" = "{{ $role }}" ]; then
              {{- if eq $pooler "" }}
              echo "$cluster_host"  # Empty mapping = direct
              {{- else }}
              echo "{{ $.Values.clusterPharia.fullnameOverride }}-pooler-{{ $pooler }}"
              {{- end }}
              return
            fi
            {{- end }}
            {{- end }}
            {{- end }}
            
            # No specific mapping, check default pooler
            if [ -n "$default_pooler" ] && [ "$default_pooler" != "null" ]; then
              echo "{{ $.Values.clusterPharia.fullnameOverride }}-pooler-$default_pooler"
            else
              echo "$cluster_host"
            fi
          }

          # Wait for PostgreSQL cluster
          wait_for_service "{{ .Values.clusterPharia.fullnameOverride }}-rw" "PostgreSQL cluster (direct)" || exit 1
          echo

          # Wait for poolers
          {{- if $.Values.clusterPharia.poolers }}
          {{- range $.Values.clusterPharia.poolers }}
          wait_for_service "{{ $.Values.clusterPharia.fullnameOverride }}-pooler-{{ .name }}" "Pooler ({{ .poolMode }} mode)" || echo "âš ï¸  Pooler not ready, will skip tests"
          {{- end }}
          {{- end }}
          echo

          FAILED_TESTS=0
          PASSED_TESTS=0
          TOTAL_USERS=0
          TOTAL_CONNECTIONS=0
          SECRET_CONFIG_TESTS=0

          # Test each role across all connection methods
          {{- range $.Values.clusterPharia.cluster.roles }}
          {{- if ne .name "pgbouncer" }}
          TOTAL_USERS=$((TOTAL_USERS + 1))
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Testing User: {{ .name }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo

          # Get credentials from secret
          USER_NAME="{{ .name }}"
          USER_PASSWORD=$(cat /secrets/{{ .name }}/password)
          SECRET_HOST=$(cat /secrets/{{ .name }}/host)
          
          # Test 0: Verify secret configuration
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Test 0: Secret Configuration Validation"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          EXPECTED_HOST=$(get_expected_host_pharia "{{ .name }}")
          echo "  Expected host: $EXPECTED_HOST"
          echo "  Secret host:   $SECRET_HOST"
          
          if [ "$SECRET_HOST" = "$EXPECTED_HOST" ]; then
            echo "  âœ… PASS - Secret contains correct host based on config"
            SECRET_CONFIG_TESTS=$((SECRET_CONFIG_TESTS + 1))
            
            # Determine connection type for display
            if [[ "$SECRET_HOST" == *"-pooler-"* ]]; then
              {{- if and ($.Values.clusterPharia.config) ($.Values.clusterPharia.config.rolePoolerMappings) }}
              {{- if hasKey $.Values.clusterPharia.config.rolePoolerMappings .name }}
              echo "  ğŸ“ Role uses specific pooler mapping"
              {{- else }}
              echo "  ğŸ“ Role uses default pooler"
              {{- end }}
              {{- else }}
              echo "  ğŸ“ Role uses default pooler"
              {{- end }}
            else
              echo "  ğŸ“ Role uses direct cluster connection"
            fi
          else
            echo "  âŒ FAIL - Secret host doesn't match configuration"
            FAILED_TESTS=$((FAILED_TESTS + 1))
          fi
          echo
          
          # Test connection using the configured endpoint from secret
          TOTAL_CONNECTIONS=$((TOTAL_CONNECTIONS + 1))
          if run_tests "$SECRET_HOST" "Configured Endpoint (from secret)" "$USER_NAME" "$USER_PASSWORD"; then
            PASSED_TESTS=$((PASSED_TESTS + 3))
          else
            FAILED_TESTS=$((FAILED_TESTS + $?))
            PASSED_TESTS=$((PASSED_TESTS + 3 - $?))
          fi

          # Test 1: Direct cluster connection (infrastructure validation)
          TOTAL_CONNECTIONS=$((TOTAL_CONNECTIONS + 1))
          if run_tests "{{ $.Values.clusterPharia.fullnameOverride }}-rw" "Direct Cluster" "$USER_NAME" "$USER_PASSWORD"; then
            PASSED_TESTS=$((PASSED_TESTS + 3))
          else
            FAILED_TESTS=$((FAILED_TESTS + $?))
            PASSED_TESTS=$((PASSED_TESTS + 3 - $?))
          fi

          # Test 2: Transaction pooler connection
          {{- if $.Values.clusterPharia.poolers }}
          {{- range $.Values.clusterPharia.poolers }}
          {{- if eq .poolMode "transaction" }}
          TOTAL_CONNECTIONS=$((TOTAL_CONNECTIONS + 1))
          if run_tests "{{ $.Values.clusterPharia.fullnameOverride }}-pooler-{{ .name }}" "Native Pooler (Transaction Mode)" "$USER_NAME" "$USER_PASSWORD"; then
            PASSED_TESTS=$((PASSED_TESTS + 3))
          else
            FAILED_TESTS=$((FAILED_TESTS + $?))
            PASSED_TESTS=$((PASSED_TESTS + 3 - $?))
          fi
          {{- end }}
          {{- end }}
          {{- end }}

          # Test 3: Session pooler connection
          {{- if $.Values.clusterPharia.poolers }}
          {{- range $.Values.clusterPharia.poolers }}
          {{- if eq .poolMode "session" }}
          TOTAL_CONNECTIONS=$((TOTAL_CONNECTIONS + 1))
          if run_tests "{{ $.Values.clusterPharia.fullnameOverride }}-pooler-{{ .name }}" "Native Pooler (Session Mode)" "$USER_NAME" "$USER_PASSWORD"; then
            PASSED_TESTS=$((PASSED_TESTS + 3))
          else
            FAILED_TESTS=$((FAILED_TESTS + $?))
            PASSED_TESTS=$((PASSED_TESTS + 3 - $?))
          fi
          {{- end }}
          {{- end }}
          {{- end }}

          echo
          {{- end }}
          {{- end }}

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Test Summary - Pharia Cluster"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Users Tested: $TOTAL_USERS"
          echo "  Secret Config Tests: $SECRET_CONFIG_TESTS passed"
          echo ""
          echo "  Connection Configuration:"
          {{- if $.Values.clusterPharia.config }}
          {{- if $.Values.clusterPharia.config.defaultPooler }}
          echo "    â€¢ Default pooler: {{ $.Values.clusterPharia.config.defaultPooler }}"
          {{- else }}
          echo "    â€¢ Default pooler: none (direct connection)"
          {{- end }}
          {{- if $.Values.clusterPharia.config.rolePoolerMappings }}
          echo "    â€¢ Specific mappings:"
          {{- range $role, $pooler := $.Values.clusterPharia.config.rolePoolerMappings }}
          {{- if eq $pooler "" }}
          echo "      - {{ $role }}: direct (override)"
          {{- else }}
          echo "      - {{ $role }}: {{ $pooler }}"
          {{- end }}
          {{- end }}
          {{- end }}
          {{- end }}
          echo ""
          echo "  Infrastructure Tests (all connection methods):"
          echo "    â€¢ Direct cluster connection"
          {{- if $.Values.clusterPharia.poolers }}
          {{- range $.Values.clusterPharia.poolers }}
          echo "    â€¢ Native pooler ({{ .poolMode }} mode)"
          {{- end }}
          {{- end }}
          echo ""
          echo "  Total Tests Passed: $PASSED_TESTS"
          echo "  Total Tests Failed: $FAILED_TESTS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          if [ $FAILED_TESTS -gt 0 ]; then
            echo
            echo "âŒ Some tests failed"
            exit 1
          fi

          echo
          echo "âœ… All tests passed successfully!"
          echo "âœ… Secret configuration matches role-pooler mappings"
          echo "âœ… All users can connect via all methods (direct + poolers)"
          exit 0
      volumeMounts:
        {{- range $.Values.clusterPharia.cluster.roles }}
        {{- if ne .name "pgbouncer" }}
        - name: secret-{{ .name | replace "_" "-" }}
          mountPath: /secrets/{{ .name }}
          readOnly: true
        {{- end }}
        {{- end }}
  volumes:
    {{- range $.Values.clusterPharia.cluster.roles }}
    {{- if ne .name "pgbouncer" }}
    - name: secret-{{ .name | replace "_" "-" }}
      secret:
        secretName: qs-postgresql-cluster-access-{{ .name | replace "_" "-" }}
        items:
          - key: password
            path: password
          - key: host
            path: host
          - key: port
            path: port
          - key: databaseName
            path: database
    {{- end }}
    {{- end }}
{{- end }}
{{- if .Values.clusterTemporal.enabled }}
---
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "qs-postgresql-cluster.fullname" . }}-test-temporal
  labels:
    {{- include "qs-postgresql-cluster.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
    cluster: temporal
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
    - name: test-connection
      image: {{ .Values.tests.image | default "postgres:17" }}
      imagePullPolicy: IfNotPresent
      env:
        - name: PGHOST
          value: "{{ .Values.clusterTemporal.fullnameOverride }}-rw"
        - name: PGSSLMODE
          value: {{ .Values.tests.sslMode | default "prefer" | quote }}
      command:
        - /bin/bash
        - -c
        - |
          set -e

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  PostgreSQL Cluster Connection Test"
          echo "  Cluster: Temporal"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo

          # Function to wait for a service to be ready
          wait_for_service() {
            local host=$1
            local description=$2
            
            echo "â³ Waiting for $description to be ready..."
            MAX_RETRIES=30
            RETRY=0
            until pg_isready -h "$host" -U postgres 2>/dev/null || [ $RETRY -eq $MAX_RETRIES ]; do
              echo "   Waiting... (attempt $((RETRY+1))/$MAX_RETRIES)"
              sleep 5
              RETRY=$((RETRY+1))
            done

            if [ $RETRY -eq $MAX_RETRIES ]; then
              echo "âŒ ERROR: $description did not become ready in time"
              return 1
            fi
            echo "âœ… $description is ready"
            return 0
          }

          # Function to run connection tests
          run_tests() {
            local host=$1
            local connection_type=$2
            local user=$3
            local password=$4
            local tests_passed=0
            local tests_failed=0
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "  Connection: $connection_type"
            echo "  Host: $host"
            echo "  User: $user"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Test 1: Basic connectivity
            echo -n "  Test 1: Basic connectivity... "
            if PGPASSWORD="$password" psql -h "$host" -U "$user" -d postgres -c "SELECT 1;" > /dev/null 2>&1; then
              echo "âœ… PASS"
              tests_passed=$((tests_passed + 1))
            else
              echo "âŒ FAIL"
              tests_failed=$((tests_failed + 1))
            fi

            # Test 2: Current user verification
            echo -n "  Test 2: User verification... "
            RESULT=$(PGPASSWORD="$password" psql -h "$host" -U "$user" -d postgres -t -c "SELECT current_user;" 2>&1 | xargs)
            if [ "$RESULT" = "$user" ]; then
              echo "âœ… PASS"
              tests_passed=$((tests_passed + 1))
            else
              echo "âŒ FAIL (expected: $user, got: $RESULT)"
              tests_failed=$((tests_failed + 1))
            fi

            # Test 3: Query execution
            echo -n "  Test 3: Query execution... "
            RESULT=$(PGPASSWORD="$password" psql -h "$host" -U "$user" -d postgres -t -c "SELECT 42;" 2>&1 | xargs)
            if [ "$RESULT" = "42" ]; then
              echo "âœ… PASS"
              tests_passed=$((tests_passed + 1))
            else
              echo "âŒ FAIL"
              tests_failed=$((tests_failed + 1))
            fi
            
            echo "  Summary: $tests_passed passed, $tests_failed failed"
            echo
            
            return $tests_failed
          }

          # Function to get expected host for a role based on config
          get_expected_host_temporal() {
            local role=$1
            local cluster_host="{{ .Values.clusterTemporal.fullnameOverride }}-rw"
            local default_pooler="{{ .Values.clusterTemporal.config.defaultPooler | default "" }}"
            
            # Check for specific mapping first
            {{- if $.Values.clusterTemporal.config }}
            {{- if $.Values.clusterTemporal.config.rolePoolerMappings }}
            {{- range $role, $pooler := $.Values.clusterTemporal.config.rolePoolerMappings }}
            if [ "$role" = "{{ $role }}" ]; then
              {{- if eq $pooler "" }}
              echo "$cluster_host"  # Empty mapping = direct
              {{- else }}
              echo "{{ $.Values.clusterTemporal.fullnameOverride }}-pooler-{{ $pooler }}"
              {{- end }}
              return
            fi
            {{- end }}
            {{- end }}
            {{- end }}
            
            # No specific mapping, check default pooler
            if [ -n "$default_pooler" ] && [ "$default_pooler" != "null" ]; then
              echo "{{ $.Values.clusterTemporal.fullnameOverride }}-pooler-$default_pooler"
            else
              echo "$cluster_host"
            fi
          }

          # Wait for PostgreSQL cluster
          wait_for_service "{{ .Values.clusterTemporal.fullnameOverride }}-rw" "PostgreSQL cluster (direct)" || exit 1
          echo

          # Wait for poolers
          {{- if $.Values.clusterTemporal.poolers }}
          {{- range $.Values.clusterTemporal.poolers }}
          wait_for_service "{{ $.Values.clusterTemporal.fullnameOverride }}-pooler-{{ .name }}" "Pooler ({{ .poolMode }} mode)" || echo "âš ï¸  Pooler not ready, will skip tests"
          {{- end }}
          {{- end }}
          echo

          FAILED_TESTS=0
          PASSED_TESTS=0
          TOTAL_USERS=0
          TOTAL_CONNECTIONS=0
          SECRET_CONFIG_TESTS=0

          # Test each role across all connection methods
          {{- range $.Values.clusterTemporal.cluster.roles }}
          {{- if ne .name "pgbouncer" }}
          TOTAL_USERS=$((TOTAL_USERS + 1))
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Testing User: {{ .name }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo

          # Get credentials from secret
          USER_NAME="{{ .name }}"
          USER_PASSWORD=$(cat /secrets/{{ .name }}/password)
          SECRET_HOST=$(cat /secrets/{{ .name }}/host)
          
          # Test 0: Verify secret configuration
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Test 0: Secret Configuration Validation"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          EXPECTED_HOST=$(get_expected_host_temporal "{{ .name }}")
          echo "  Expected host: $EXPECTED_HOST"
          echo "  Secret host:   $SECRET_HOST"
          
          if [ "$SECRET_HOST" = "$EXPECTED_HOST" ]; then
            echo "  âœ… PASS - Secret contains correct host based on config"
            SECRET_CONFIG_TESTS=$((SECRET_CONFIG_TESTS + 1))
            
            # Determine connection type for display
            if [[ "$SECRET_HOST" == *"-pooler-"* ]]; then
              {{- if and ($.Values.clusterTemporal.config) ($.Values.clusterTemporal.config.rolePoolerMappings) }}
              {{- if hasKey $.Values.clusterTemporal.config.rolePoolerMappings .name }}
              echo "  ğŸ“ Role uses specific pooler mapping"
              {{- else }}
              echo "  ğŸ“ Role uses default pooler"
              {{- end }}
              {{- else }}
              echo "  ğŸ“ Role uses default pooler"
              {{- end }}
            else
              echo "  ğŸ“ Role uses direct cluster connection"
            fi
          else
            echo "  âŒ FAIL - Secret host doesn't match configuration"
            FAILED_TESTS=$((FAILED_TESTS + 1))
          fi
          echo
          
          # Test connection using the configured endpoint from secret
          TOTAL_CONNECTIONS=$((TOTAL_CONNECTIONS + 1))
          if run_tests "$SECRET_HOST" "Configured Endpoint (from secret)" "$USER_NAME" "$USER_PASSWORD"; then
            PASSED_TESTS=$((PASSED_TESTS + 3))
          else
            FAILED_TESTS=$((FAILED_TESTS + $?))
            PASSED_TESTS=$((PASSED_TESTS + 3 - $?))
          fi

          # Test 1: Direct cluster connection (infrastructure validation)
          TOTAL_CONNECTIONS=$((TOTAL_CONNECTIONS + 1))
          if run_tests "{{ $.Values.clusterTemporal.fullnameOverride }}-rw" "Direct Cluster" "$USER_NAME" "$USER_PASSWORD"; then
            PASSED_TESTS=$((PASSED_TESTS + 3))
          else
            FAILED_TESTS=$((FAILED_TESTS + $?))
            PASSED_TESTS=$((PASSED_TESTS + 3 - $?))
          fi

          # Test 2: Transaction pooler connection
          {{- if $.Values.clusterTemporal.poolers }}
          {{- range $.Values.clusterTemporal.poolers }}
          {{- if eq .poolMode "transaction" }}
          TOTAL_CONNECTIONS=$((TOTAL_CONNECTIONS + 1))
          if run_tests "{{ $.Values.clusterTemporal.fullnameOverride }}-pooler-{{ .name }}" "Native Pooler (Transaction Mode)" "$USER_NAME" "$USER_PASSWORD"; then
            PASSED_TESTS=$((PASSED_TESTS + 3))
          else
            FAILED_TESTS=$((FAILED_TESTS + $?))
            PASSED_TESTS=$((PASSED_TESTS + 3 - $?))
          fi
          {{- end }}
          {{- end }}
          {{- end }}

          # Test 3: Session pooler connection
          {{- if $.Values.clusterTemporal.poolers }}
          {{- range $.Values.clusterTemporal.poolers }}
          {{- if eq .poolMode "session" }}
          TOTAL_CONNECTIONS=$((TOTAL_CONNECTIONS + 1))
          if run_tests "{{ $.Values.clusterTemporal.fullnameOverride }}-pooler-{{ .name }}" "Native Pooler (Session Mode)" "$USER_NAME" "$USER_PASSWORD"; then
            PASSED_TESTS=$((PASSED_TESTS + 3))
          else
            FAILED_TESTS=$((FAILED_TESTS + $?))
            PASSED_TESTS=$((PASSED_TESTS + 3 - $?))
          fi
          {{- end }}
          {{- end }}
          {{- end }}

          echo
          {{- end }}
          {{- end }}

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Test Summary - Temporal Cluster"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Users Tested: $TOTAL_USERS"
          echo "  Secret Config Tests: $SECRET_CONFIG_TESTS passed"
          echo ""
          echo "  Connection Configuration:"
          {{- if $.Values.clusterTemporal.config }}
          {{- if $.Values.clusterTemporal.config.defaultPooler }}
          echo "    â€¢ Default pooler: {{ $.Values.clusterTemporal.config.defaultPooler }}"
          {{- else }}
          echo "    â€¢ Default pooler: none (direct connection)"
          {{- end }}
          {{- if $.Values.clusterTemporal.config.rolePoolerMappings }}
          echo "    â€¢ Specific mappings:"
          {{- range $role, $pooler := $.Values.clusterTemporal.config.rolePoolerMappings }}
          {{- if eq $pooler "" }}
          echo "      - {{ $role }}: direct (override)"
          {{- else }}
          echo "      - {{ $role }}: {{ $pooler }}"
          {{- end }}
          {{- end }}
          {{- end }}
          {{- end }}
          echo ""
          echo "  Infrastructure Tests (all connection methods):"
          echo "    â€¢ Direct cluster connection"
          {{- if $.Values.clusterTemporal.poolers }}
          {{- range $.Values.clusterTemporal.poolers }}
          echo "    â€¢ Native pooler ({{ .poolMode }} mode)"
          {{- end }}
          {{- end }}
          echo ""
          echo "  Total Tests Passed: $PASSED_TESTS"
          echo "  Total Tests Failed: $FAILED_TESTS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          if [ $FAILED_TESTS -gt 0 ]; then
            echo
            echo "âŒ Some tests failed"
            exit 1
          fi

          echo
          echo "âœ… All tests passed successfully!"
          echo "âœ… Secret configuration matches role-pooler mappings"
          echo "âœ… All users can connect via all methods (direct + poolers)"
          exit 0
      volumeMounts:
        {{- range $.Values.clusterTemporal.cluster.roles }}
        {{- if ne .name "pgbouncer" }}
        - name: secret-{{ .name | replace "_" "-" }}
          mountPath: /secrets/{{ .name }}
          readOnly: true
        {{- end }}
        {{- end }}
  volumes:
    {{- range $.Values.clusterTemporal.cluster.roles }}
    {{- if ne .name "pgbouncer" }}
    - name: secret-{{ .name | replace "_" "-" }}
      secret:
        secretName: qs-postgresql-cluster-access-{{ .name | replace "_" "-" }}
        items:
          - key: password
            path: password
          - key: host
            path: host
          - key: port
            path: port
          - key: databaseName
            path: database
    {{- end }}
    {{- end }}
{{- end }}

