{{- if .Values.clusterPharia.enabled }}
---
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "qs-postgresql-cluster.fullname" . }}-test-pharia
  labels:
    {{- include "qs-postgresql-cluster.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
    cluster: pharia
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
    - name: test-connection
      image: {{ .Values.tests.image | default "postgres:17" }}
      imagePullPolicy: IfNotPresent
      env:
        - name: PGHOST
          value: "cluster-pharia-rw"
        - name: PGSSLMODE
          value: {{ .Values.tests.sslMode | default "prefer" | quote }}
      command:
        - /bin/bash
        - -c
        - |
          set -e

          echo "════════════════════════════════════════════════════════════════"
          echo "  PostgreSQL Cluster Connection Test"
          echo "  Cluster: Pharia"
          echo "════════════════════════════════════════════════════════════════"
          echo

          # Wait for PostgreSQL to be ready
          echo "⏳ Waiting for PostgreSQL cluster to be ready..."
          MAX_RETRIES=30
          RETRY=0
          until pg_isready -h $PGHOST -U postgres || [ $RETRY -eq $MAX_RETRIES ]; do
            echo "   Waiting... (attempt $((RETRY+1))/$MAX_RETRIES)"
            sleep 5
            RETRY=$((RETRY+1))
          done

          if [ $RETRY -eq $MAX_RETRIES ]; then
            echo "❌ ERROR: PostgreSQL cluster did not become ready in time"
            exit 1
          fi
          echo "✅ PostgreSQL cluster is ready"
          echo

          FAILED_TESTS=0
          PASSED_TESTS=0
          TOTAL_USERS=0

          # Test each role
          {{- range .Values.clusterPharia.cluster.roles }}
          {{- if ne .name "pgbouncer" }}
          TOTAL_USERS=$((TOTAL_USERS + 1))
          echo "────────────────────────────────────────────────────────────────"
          echo "Testing User: {{ .name }}"
          echo "────────────────────────────────────────────────────────────────"

          # Get credentials from secret
          SECRET_NAME="{{ .name | replace "_" "-" }}-pg-secret-qs"
          PGPASSWORD=$(cat /secrets/{{ .name }}/password)
          export PGPASSWORD
          export PGUSER="{{ .name }}"
          # Connect to postgres database (always exists) for connectivity tests
          export PGDATABASE="postgres"

          # Test 1: Basic connectivity
          echo -n "  Test 1: Basic connectivity... "
          if psql -h $PGHOST -c "SELECT 1;" > /dev/null 2>&1; then
            echo "✅ PASS"
            PASSED_TESTS=$((PASSED_TESTS + 1))
          else
            echo "❌ FAIL"
            FAILED_TESTS=$((FAILED_TESTS + 1))
          fi

          # Test 2: Current user verification
          echo -n "  Test 2: User verification... "
          RESULT=$(psql -h $PGHOST -t -c "SELECT current_user;" 2>&1 | xargs)
          if [ "$RESULT" = "{{ .name }}" ]; then
            echo "✅ PASS"
            PASSED_TESTS=$((PASSED_TESTS + 1))
          else
            echo "❌ FAIL (expected: {{ .name }}, got: $RESULT)"
            FAILED_TESTS=$((FAILED_TESTS + 1))
          fi

          # Test 3: Check if user's dedicated database exists
          echo -n "  Test 3: User database check... "
          USER_DB="{{ .name | replace "_" "-" }}"
          if psql -h $PGHOST -t -c "SELECT 1 FROM pg_database WHERE datname='$USER_DB';" 2>/dev/null | grep -q 1; then
            echo "✅ PASS (database '$USER_DB' exists)"
            PASSED_TESTS=$((PASSED_TESTS + 1))
          else
            echo "ℹ️  INFO (database '$USER_DB' not created yet - created by qs-postgresql-db chart)"
            PASSED_TESTS=$((PASSED_TESTS + 1))
          fi

          # Test 4: Write operations (temp table)
          echo -n "  Test 4: Write operations... "
          if psql -h $PGHOST -c "CREATE TEMP TABLE helm_test (id serial, data text); INSERT INTO helm_test (data) VALUES ('test'); DROP TABLE helm_test;" > /dev/null 2>&1; then
            echo "✅ PASS"
            PASSED_TESTS=$((PASSED_TESTS + 1))
          else
            echo "❌ FAIL"
            FAILED_TESTS=$((FAILED_TESTS + 1))
          fi

          # Test 5: Secret fields verification
          echo -n "  Test 5: Secret fields verification... "
          if [ -n "$PGPASSWORD" ] && [ -n "$PGUSER" ] && [ -n "$PGDATABASE" ]; then
            if [ -f "/secrets/{{ .name }}/host" ] && [ -f "/secrets/{{ .name }}/port" ]; then
              echo "✅ PASS"
              PASSED_TESTS=$((PASSED_TESTS + 1))
            else
              echo "❌ FAIL (missing secret fields)"
              FAILED_TESTS=$((FAILED_TESTS + 1))
            fi
          else
            echo "❌ FAIL (missing credentials)"
            FAILED_TESTS=$((FAILED_TESTS + 1))
          fi

          echo
          {{- end }}
          {{- end }}

          echo "════════════════════════════════════════════════════════════════"
          echo "  Test Summary - Pharia Cluster"
          echo "════════════════════════════════════════════════════════════════"
          echo "  Users Tested: $TOTAL_USERS"
          echo "  Tests Passed: $PASSED_TESTS"
          echo "  Tests Failed: $FAILED_TESTS"
          echo "════════════════════════════════════════════════════════════════"

          if [ $FAILED_TESTS -gt 0 ]; then
            echo
            echo "❌ Some tests failed"
            exit 1
          fi

          echo
          echo "✅ All tests passed successfully!"
          exit 0
      volumeMounts:
        {{- range .Values.clusterPharia.cluster.roles }}
        {{- if ne .name "pgbouncer" }}
        - name: secret-{{ .name | replace "_" "-" }}
          mountPath: /secrets/{{ .name }}
          readOnly: true
        {{- end }}
        {{- end }}
  volumes:
    {{- range .Values.clusterPharia.cluster.roles }}
    {{- if ne .name "pgbouncer" }}
    - name: secret-{{ .name | replace "_" "-" }}
      secret:
        secretName: {{ .name | replace "_" "-" }}-pg-secret-qs
        items:
          - key: password
            path: password
          - key: host
            path: host
          - key: port
            path: port
          - key: database
            path: database
    {{- end }}
    {{- end }}
{{- end }}
{{- if .Values.clusterTemporal.enabled }}
---
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "qs-postgresql-cluster.fullname" . }}-test-temporal
  labels:
    {{- include "qs-postgresql-cluster.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
    cluster: temporal
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
    - name: test-connection
      image: {{ .Values.tests.image | default "postgres:17" }}
      imagePullPolicy: IfNotPresent
      env:
        - name: PGHOST
          value: "cluster-temporal-rw"
        - name: PGSSLMODE
          value: {{ .Values.tests.sslMode | default "prefer" | quote }}
      command:
        - /bin/bash
        - -c
        - |
          set -e

          echo "════════════════════════════════════════════════════════════════"
          echo "  PostgreSQL Cluster Connection Test"
          echo "  Cluster: Temporal"
          echo "════════════════════════════════════════════════════════════════"
          echo

          # Wait for PostgreSQL to be ready
          echo "⏳ Waiting for PostgreSQL cluster to be ready..."
          MAX_RETRIES=30
          RETRY=0
          until pg_isready -h $PGHOST -U postgres || [ $RETRY -eq $MAX_RETRIES ]; do
            echo "   Waiting... (attempt $((RETRY+1))/$MAX_RETRIES)"
            sleep 5
            RETRY=$((RETRY+1))
          done

          if [ $RETRY -eq $MAX_RETRIES ]; then
            echo "❌ ERROR: PostgreSQL cluster did not become ready in time"
            exit 1
          fi
          echo "✅ PostgreSQL cluster is ready"
          echo

          FAILED_TESTS=0
          PASSED_TESTS=0
          TOTAL_USERS=0

          # Test each role
          {{- range .Values.clusterTemporal.cluster.roles }}
          {{- if ne .name "pgbouncer" }}
          TOTAL_USERS=$((TOTAL_USERS + 1))
          echo "────────────────────────────────────────────────────────────────"
          echo "Testing User: {{ .name }}"
          echo "────────────────────────────────────────────────────────────────"

          # Get credentials from secret
          SECRET_NAME="{{ .name | replace "_" "-" }}-pg-secret-qs"
          PGPASSWORD=$(cat /secrets/{{ .name }}/password)
          export PGPASSWORD
          export PGUSER="{{ .name }}"
          # Connect to postgres database (always exists) for connectivity tests
          export PGDATABASE="postgres"

          # Test 1: Basic connectivity
          echo -n "  Test 1: Basic connectivity... "
          if psql -h $PGHOST -c "SELECT 1;" > /dev/null 2>&1; then
            echo "✅ PASS"
            PASSED_TESTS=$((PASSED_TESTS + 1))
          else
            echo "❌ FAIL"
            FAILED_TESTS=$((FAILED_TESTS + 1))
          fi

          # Test 2: Current user verification
          echo -n "  Test 2: User verification... "
          RESULT=$(psql -h $PGHOST -t -c "SELECT current_user;" 2>&1 | xargs)
          if [ "$RESULT" = "{{ .name }}" ]; then
            echo "✅ PASS"
            PASSED_TESTS=$((PASSED_TESTS + 1))
          else
            echo "❌ FAIL (expected: {{ .name }}, got: $RESULT)"
            FAILED_TESTS=$((FAILED_TESTS + 1))
          fi

          # Test 3: Check if user's dedicated database exists
          echo -n "  Test 3: User database check... "
          USER_DB="{{ .name | replace "_" "-" }}"
          if psql -h $PGHOST -t -c "SELECT 1 FROM pg_database WHERE datname='$USER_DB';" 2>/dev/null | grep -q 1; then
            echo "✅ PASS (database '$USER_DB' exists)"
            PASSED_TESTS=$((PASSED_TESTS + 1))
          else
            echo "ℹ️  INFO (database '$USER_DB' not created yet - created by qs-postgresql-db chart)"
            PASSED_TESTS=$((PASSED_TESTS + 1))
          fi

          # Test 4: Write operations (temp table)
          echo -n "  Test 4: Write operations... "
          if psql -h $PGHOST -c "CREATE TEMP TABLE helm_test (id serial, data text); INSERT INTO helm_test (data) VALUES ('test'); DROP TABLE helm_test;" > /dev/null 2>&1; then
            echo "✅ PASS"
            PASSED_TESTS=$((PASSED_TESTS + 1))
          else
            echo "❌ FAIL"
            FAILED_TESTS=$((FAILED_TESTS + 1))
          fi

          # Test 5: Secret fields verification
          echo -n "  Test 5: Secret fields verification... "
          if [ -n "$PGPASSWORD" ] && [ -n "$PGUSER" ] && [ -n "$PGDATABASE" ]; then
            if [ -f "/secrets/{{ .name }}/host" ] && [ -f "/secrets/{{ .name }}/port" ]; then
              echo "✅ PASS"
              PASSED_TESTS=$((PASSED_TESTS + 1))
            else
              echo "❌ FAIL (missing secret fields)"
              FAILED_TESTS=$((FAILED_TESTS + 1))
            fi
          else
            echo "❌ FAIL (missing credentials)"
            FAILED_TESTS=$((FAILED_TESTS + 1))
          fi

          echo
          {{- end }}
          {{- end }}

          echo "════════════════════════════════════════════════════════════════"
          echo "  Test Summary - Temporal Cluster"
          echo "════════════════════════════════════════════════════════════════"
          echo "  Users Tested: $TOTAL_USERS"
          echo "  Tests Passed: $PASSED_TESTS"
          echo "  Tests Failed: $FAILED_TESTS"
          echo "════════════════════════════════════════════════════════════════"

          if [ $FAILED_TESTS -gt 0 ]; then
            echo
            echo "❌ Some tests failed"
            exit 1
          fi

          echo
          echo "✅ All tests passed successfully!"
          exit 0
      volumeMounts:
        {{- range .Values.clusterTemporal.cluster.roles }}
        {{- if ne .name "pgbouncer" }}
        - name: secret-{{ .name | replace "_" "-" }}
          mountPath: /secrets/{{ .name }}
          readOnly: true
        {{- end }}
        {{- end }}
  volumes:
    {{- range .Values.clusterTemporal.cluster.roles }}
    {{- if ne .name "pgbouncer" }}
    - name: secret-{{ .name | replace "_" "-" }}
      secret:
        secretName: {{ .name | replace "_" "-" }}-pg-secret-qs
        items:
          - key: password
            path: password
          - key: host
            path: host
          - key: port
            path: port
          - key: database
            path: database
    {{- end }}
    {{- end }}
{{- end }}

