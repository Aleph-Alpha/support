{{- if .Values.clusterPharia.enabled }}
---
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "qs-postgresql-cluster.fullname" . }}-test-pharia
  labels:
    {{- include "qs-postgresql-cluster.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
    cluster: pharia
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
    - name: test-connection
      image: {{ .Values.tests.image | default "postgres:17" }}
      imagePullPolicy: IfNotPresent
      env:
        - name: PGHOST
          value: "{{ .Values.clusterPharia.fullnameOverride }}-rw"
        - name: PGSSLMODE
          value: {{ .Values.tests.sslMode | default "prefer" | quote }}
      command:
        - /bin/bash
        - -c
        - |
          set -e

          echo "════════════════════════════════════════════════════════════════"
          echo "  PostgreSQL Cluster Connection Test"
          echo "  Cluster: Pharia"
          echo "════════════════════════════════════════════════════════════════"
          echo

          # Function to wait for a service to be ready
          wait_for_service() {
            local host=$1
            local description=$2
            
            echo "⏳ Waiting for $description to be ready..."
            MAX_RETRIES=30
            RETRY=0
            until pg_isready -h "$host" -U postgres 2>/dev/null || [ $RETRY -eq $MAX_RETRIES ]; do
              echo "   Waiting... (attempt $((RETRY+1))/$MAX_RETRIES)"
              sleep 5
              RETRY=$((RETRY+1))
            done

            if [ $RETRY -eq $MAX_RETRIES ]; then
              echo "❌ ERROR: $description did not become ready in time"
              return 1
            fi
            echo "✅ $description is ready"
            return 0
          }

          # Function to run connection tests
          run_tests() {
            local host=$1
            local connection_type=$2
            local user=$3
            local password=$4
            local tests_passed=0
            local tests_failed=0
            
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "  Connection: $connection_type"
            echo "  Host: $host"
            echo "  User: $user"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            
            # Test 1: Basic connectivity
            echo -n "  Test 1: Basic connectivity... "
            if PGPASSWORD="$password" psql -h "$host" -U "$user" -d postgres -c "SELECT 1;" > /dev/null 2>&1; then
              echo "✅ PASS"
              tests_passed=$((tests_passed + 1))
            else
              echo "❌ FAIL"
              tests_failed=$((tests_failed + 1))
            fi

            # Test 2: Current user verification
            echo -n "  Test 2: User verification... "
            RESULT=$(PGPASSWORD="$password" psql -h "$host" -U "$user" -d postgres -t -c "SELECT current_user;" 2>&1 | xargs)
            if [ "$RESULT" = "$user" ]; then
              echo "✅ PASS"
              tests_passed=$((tests_passed + 1))
            else
              echo "❌ FAIL (expected: $user, got: $RESULT)"
              tests_failed=$((tests_failed + 1))
            fi

            # Test 3: Query execution
            echo -n "  Test 3: Query execution... "
            RESULT=$(PGPASSWORD="$password" psql -h "$host" -U "$user" -d postgres -t -c "SELECT 42;" 2>&1 | xargs)
            if [ "$RESULT" = "42" ]; then
              echo "✅ PASS"
              tests_passed=$((tests_passed + 1))
            else
              echo "❌ FAIL"
              tests_failed=$((tests_failed + 1))
            fi
            
            echo "  Summary: $tests_passed passed, $tests_failed failed"
            echo
            
            return $tests_failed
          }

          # Wait for PostgreSQL cluster
          wait_for_service "{{ .Values.clusterPharia.fullnameOverride }}-rw" "PostgreSQL cluster (direct)" || exit 1
          echo

          # Wait for poolers
          {{- if $.Values.clusterPharia.poolers }}
          {{- range $.Values.clusterPharia.poolers }}
          wait_for_service "{{ $.Values.clusterPharia.fullnameOverride }}-pooler-{{ .name }}" "Pooler ({{ .poolMode }} mode)" || echo "⚠️  Pooler not ready, will skip tests"
          {{- end }}
          {{- end }}
          echo

          FAILED_TESTS=0
          PASSED_TESTS=0
          TOTAL_USERS=0
          TOTAL_CONNECTIONS=0

          # Test each role across all connection methods
          {{- range $.Values.clusterPharia.cluster.roles }}
          {{- if ne .name "pgbouncer" }}
          TOTAL_USERS=$((TOTAL_USERS + 1))
          echo "════════════════════════════════════════════════════════════════"
          echo "  Testing User: {{ .name }}"
          echo "════════════════════════════════════════════════════════════════"
          echo

          # Get credentials from secret
          USER_NAME="{{ .name }}"
          USER_PASSWORD=$(cat /secrets/{{ .name }}/password)

          # Test 1: Direct cluster connection
          TOTAL_CONNECTIONS=$((TOTAL_CONNECTIONS + 1))
          if run_tests "{{ $.Values.clusterPharia.fullnameOverride }}-rw" "Direct Cluster" "$USER_NAME" "$USER_PASSWORD"; then
            PASSED_TESTS=$((PASSED_TESTS + 3))
          else
            FAILED_TESTS=$((FAILED_TESTS + $?))
            PASSED_TESTS=$((PASSED_TESTS + 3 - $?))
          fi

          # Test 2: Transaction pooler connection
          {{- if $.Values.clusterPharia.poolers }}
          {{- range $.Values.clusterPharia.poolers }}
          {{- if eq .poolMode "transaction" }}
          TOTAL_CONNECTIONS=$((TOTAL_CONNECTIONS + 1))
          if run_tests "{{ $.Values.clusterPharia.fullnameOverride }}-pooler-{{ .name }}" "Native Pooler (Transaction Mode)" "$USER_NAME" "$USER_PASSWORD"; then
            PASSED_TESTS=$((PASSED_TESTS + 3))
          else
            FAILED_TESTS=$((FAILED_TESTS + $?))
            PASSED_TESTS=$((PASSED_TESTS + 3 - $?))
          fi
          {{- end }}
          {{- end }}
          {{- end }}

          # Test 3: Session pooler connection
          {{- if $.Values.clusterPharia.poolers }}
          {{- range $.Values.clusterPharia.poolers }}
          {{- if eq .poolMode "session" }}
          TOTAL_CONNECTIONS=$((TOTAL_CONNECTIONS + 1))
          if run_tests "{{ $.Values.clusterPharia.fullnameOverride }}-pooler-{{ .name }}" "Native Pooler (Session Mode)" "$USER_NAME" "$USER_PASSWORD"; then
            PASSED_TESTS=$((PASSED_TESTS + 3))
          else
            FAILED_TESTS=$((FAILED_TESTS + $?))
            PASSED_TESTS=$((PASSED_TESTS + 3 - $?))
          fi
          {{- end }}
          {{- end }}
          {{- end }}

          echo
          {{- end }}
          {{- end }}

          echo "════════════════════════════════════════════════════════════════"
          echo "  Test Summary - Pharia Cluster"
          echo "════════════════════════════════════════════════════════════════"
          echo "  Users Tested: $TOTAL_USERS"
          echo "  Connection Methods: $TOTAL_CONNECTIONS"
          echo "    • Direct cluster connection"
          {{- if $.Values.clusterPharia.poolers }}
          {{- range $.Values.clusterPharia.poolers }}
          echo "    • Native pooler ({{ .poolMode }} mode)"
          {{- end }}
          {{- end }}
          echo "  Tests Passed: $PASSED_TESTS"
          echo "  Tests Failed: $FAILED_TESTS"
          echo "════════════════════════════════════════════════════════════════"

          if [ $FAILED_TESTS -gt 0 ]; then
            echo
            echo "❌ Some tests failed"
            exit 1
          fi

          echo
          echo "✅ All tests passed successfully!"
          echo "✅ All users can connect via all methods (direct + poolers)"
          exit 0
      volumeMounts:
        {{- range $.Values.clusterPharia.cluster.roles }}
        {{- if ne .name "pgbouncer" }}
        - name: secret-{{ .name | replace "_" "-" }}
          mountPath: /secrets/{{ .name }}
          readOnly: true
        {{- end }}
        {{- end }}
  volumes:
    {{- range $.Values.clusterPharia.cluster.roles }}
    {{- if ne .name "pgbouncer" }}
    - name: secret-{{ .name | replace "_" "-" }}
      secret:
        secretName: qs-postgresql-cluster-access-{{ .name | replace "_" "-" }}
        items:
          - key: password
            path: password
          - key: host
            path: host
          - key: port
            path: port
          - key: databaseName
            path: database
    {{- end }}
    {{- end }}
{{- end }}
{{- if .Values.clusterTemporal.enabled }}
---
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "qs-postgresql-cluster.fullname" . }}-test-temporal
  labels:
    {{- include "qs-postgresql-cluster.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
    cluster: temporal
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
    - name: test-connection
      image: {{ .Values.tests.image | default "postgres:17" }}
      imagePullPolicy: IfNotPresent
      env:
        - name: PGHOST
          value: "{{ .Values.clusterTemporal.fullnameOverride }}-rw"
        - name: PGSSLMODE
          value: {{ .Values.tests.sslMode | default "prefer" | quote }}
      command:
        - /bin/bash
        - -c
        - |
          set -e

          echo "════════════════════════════════════════════════════════════════"
          echo "  PostgreSQL Cluster Connection Test"
          echo "  Cluster: Temporal"
          echo "════════════════════════════════════════════════════════════════"
          echo

          # Function to wait for a service to be ready
          wait_for_service() {
            local host=$1
            local description=$2
            
            echo "⏳ Waiting for $description to be ready..."
            MAX_RETRIES=30
            RETRY=0
            until pg_isready -h "$host" -U postgres 2>/dev/null || [ $RETRY -eq $MAX_RETRIES ]; do
              echo "   Waiting... (attempt $((RETRY+1))/$MAX_RETRIES)"
              sleep 5
              RETRY=$((RETRY+1))
            done

            if [ $RETRY -eq $MAX_RETRIES ]; then
              echo "❌ ERROR: $description did not become ready in time"
              return 1
            fi
            echo "✅ $description is ready"
            return 0
          }

          # Function to run connection tests
          run_tests() {
            local host=$1
            local connection_type=$2
            local user=$3
            local password=$4
            local tests_passed=0
            local tests_failed=0
            
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "  Connection: $connection_type"
            echo "  Host: $host"
            echo "  User: $user"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            
            # Test 1: Basic connectivity
            echo -n "  Test 1: Basic connectivity... "
            if PGPASSWORD="$password" psql -h "$host" -U "$user" -d postgres -c "SELECT 1;" > /dev/null 2>&1; then
              echo "✅ PASS"
              tests_passed=$((tests_passed + 1))
            else
              echo "❌ FAIL"
              tests_failed=$((tests_failed + 1))
            fi

            # Test 2: Current user verification
            echo -n "  Test 2: User verification... "
            RESULT=$(PGPASSWORD="$password" psql -h "$host" -U "$user" -d postgres -t -c "SELECT current_user;" 2>&1 | xargs)
            if [ "$RESULT" = "$user" ]; then
              echo "✅ PASS"
              tests_passed=$((tests_passed + 1))
            else
              echo "❌ FAIL (expected: $user, got: $RESULT)"
              tests_failed=$((tests_failed + 1))
            fi

            # Test 3: Query execution
            echo -n "  Test 3: Query execution... "
            RESULT=$(PGPASSWORD="$password" psql -h "$host" -U "$user" -d postgres -t -c "SELECT 42;" 2>&1 | xargs)
            if [ "$RESULT" = "42" ]; then
              echo "✅ PASS"
              tests_passed=$((tests_passed + 1))
            else
              echo "❌ FAIL"
              tests_failed=$((tests_failed + 1))
            fi
            
            echo "  Summary: $tests_passed passed, $tests_failed failed"
            echo
            
            return $tests_failed
          }

          # Wait for PostgreSQL cluster
          wait_for_service "{{ .Values.clusterTemporal.fullnameOverride }}-rw" "PostgreSQL cluster (direct)" || exit 1
          echo

          # Wait for poolers
          {{- if $.Values.clusterTemporal.poolers }}
          {{- range $.Values.clusterTemporal.poolers }}
          wait_for_service "{{ $.Values.clusterTemporal.fullnameOverride }}-pooler-{{ .name }}" "Pooler ({{ .poolMode }} mode)" || echo "⚠️  Pooler not ready, will skip tests"
          {{- end }}
          {{- end }}
          echo

          FAILED_TESTS=0
          PASSED_TESTS=0
          TOTAL_USERS=0
          TOTAL_CONNECTIONS=0

          # Test each role across all connection methods
          {{- range $.Values.clusterTemporal.cluster.roles }}
          {{- if ne .name "pgbouncer" }}
          TOTAL_USERS=$((TOTAL_USERS + 1))
          echo "════════════════════════════════════════════════════════════════"
          echo "  Testing User: {{ .name }}"
          echo "════════════════════════════════════════════════════════════════"
          echo

          # Get credentials from secret
          USER_NAME="{{ .name }}"
          USER_PASSWORD=$(cat /secrets/{{ .name }}/password)

          # Test 1: Direct cluster connection
          TOTAL_CONNECTIONS=$((TOTAL_CONNECTIONS + 1))
          if run_tests "{{ $.Values.clusterTemporal.fullnameOverride }}-rw" "Direct Cluster" "$USER_NAME" "$USER_PASSWORD"; then
            PASSED_TESTS=$((PASSED_TESTS + 3))
          else
            FAILED_TESTS=$((FAILED_TESTS + $?))
            PASSED_TESTS=$((PASSED_TESTS + 3 - $?))
          fi

          # Test 2: Transaction pooler connection
          {{- if $.Values.clusterTemporal.poolers }}
          {{- range $.Values.clusterTemporal.poolers }}
          {{- if eq .poolMode "transaction" }}
          TOTAL_CONNECTIONS=$((TOTAL_CONNECTIONS + 1))
          if run_tests "{{ $.Values.clusterTemporal.fullnameOverride }}-pooler-{{ .name }}" "Native Pooler (Transaction Mode)" "$USER_NAME" "$USER_PASSWORD"; then
            PASSED_TESTS=$((PASSED_TESTS + 3))
          else
            FAILED_TESTS=$((FAILED_TESTS + $?))
            PASSED_TESTS=$((PASSED_TESTS + 3 - $?))
          fi
          {{- end }}
          {{- end }}
          {{- end }}

          # Test 3: Session pooler connection
          {{- if $.Values.clusterTemporal.poolers }}
          {{- range $.Values.clusterTemporal.poolers }}
          {{- if eq .poolMode "session" }}
          TOTAL_CONNECTIONS=$((TOTAL_CONNECTIONS + 1))
          if run_tests "{{ $.Values.clusterTemporal.fullnameOverride }}-pooler-{{ .name }}" "Native Pooler (Session Mode)" "$USER_NAME" "$USER_PASSWORD"; then
            PASSED_TESTS=$((PASSED_TESTS + 3))
          else
            FAILED_TESTS=$((FAILED_TESTS + $?))
            PASSED_TESTS=$((PASSED_TESTS + 3 - $?))
          fi
          {{- end }}
          {{- end }}
          {{- end }}

          echo
          {{- end }}
          {{- end }}

          echo "════════════════════════════════════════════════════════════════"
          echo "  Test Summary - Temporal Cluster"
          echo "════════════════════════════════════════════════════════════════"
          echo "  Users Tested: $TOTAL_USERS"
          echo "  Connection Methods: $TOTAL_CONNECTIONS"
          echo "    • Direct cluster connection"
          {{- if $.Values.clusterTemporal.poolers }}
          {{- range $.Values.clusterTemporal.poolers }}
          echo "    • Native pooler ({{ .poolMode }} mode)"
          {{- end }}
          {{- end }}
          echo "  Tests Passed: $PASSED_TESTS"
          echo "  Tests Failed: $FAILED_TESTS"
          echo "════════════════════════════════════════════════════════════════"

          if [ $FAILED_TESTS -gt 0 ]; then
            echo
            echo "❌ Some tests failed"
            exit 1
          fi

          echo
          echo "✅ All tests passed successfully!"
          echo "✅ All users can connect via all methods (direct + poolers)"
          exit 0
      volumeMounts:
        {{- range $.Values.clusterTemporal.cluster.roles }}
        {{- if ne .name "pgbouncer" }}
        - name: secret-{{ .name | replace "_" "-" }}
          mountPath: /secrets/{{ .name }}
          readOnly: true
        {{- end }}
        {{- end }}
  volumes:
    {{- range $.Values.clusterTemporal.cluster.roles }}
    {{- if ne .name "pgbouncer" }}
    - name: secret-{{ .name | replace "_" "-" }}
      secret:
        secretName: qs-postgresql-cluster-access-{{ .name | replace "_" "-" }}
        items:
          - key: password
            path: password
          - key: host
            path: host
          - key: port
            path: port
          - key: databaseName
            path: database
    {{- end }}
    {{- end }}
{{- end }}

