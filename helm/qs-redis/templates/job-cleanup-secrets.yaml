{{- if not .Values.secretCleanup.retainOnDelete }}
{{- $root := . -}}
{{- $instanceKeys := list "pharia-assistant-api-redis" "pharia-transcribe-app-redis" -}}
{{- $instances := dict -}}
{{- range $k := $instanceKeys }}
    {{- $cfg := index $root.Values $k | default dict -}}
    {{- if and $cfg $cfg.enabled $cfg.redisStandalone $cfg.redisStandalone.redisSecret }}
        {{- $_ := set $instances $k $cfg -}}
    {{- end -}}
{{- end -}}
{{- if gt (len $instances) 0 }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "qs-redis.fullname" . }}-cleanup-secrets
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "qs-redis.labels" . | nindent 4 }}
    app.kubernetes.io/component: cleanup-secrets
  annotations:
    "helm.sh/hook": pre-delete
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        {{- include "qs-redis.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: cleanup-secrets
    spec:
      restartPolicy: Never
      serviceAccountName: {{ include "qs-redis.serviceAccountName" . }}
      containers:
        - name: cleanup-secrets
          image: "{{ .Values.jobImage.repository }}:{{ .Values.jobImage.tag }}"
          imagePullPolicy: {{ .Values.jobImage.pullPolicy }}
          command:
            - /bin/bash
            - -c
            - |
              set -e

              # Colors for output
              RED='\033[0;31m'
              GREEN='\033[0;32m'
              YELLOW='\033[1;33m'
              BLUE='\033[0;34m'
              NC='\033[0m'

              print_status() { echo -e "${BLUE}[INFO]${NC} $1"; }
              print_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
              print_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
              print_error() { echo -e "${RED}[ERROR]${NC} $1"; }

              echo "================================================"
              echo "  Redis Secrets Cleanup"
              echo "================================================"
              echo
              print_warning "Secret retention is DISABLED (secretCleanup.retainOnDelete=false)"
              print_warning "All generated secrets will be deleted"
              echo

              secrets_deleted=0
              secrets_not_found=0

              {{- range $name, $cfg := $instances }}
              echo "----"
              print_status "Cleaning up secrets for Redis instance: {{ $name }}"

              SECRET_NAME="{{ $cfg.redisStandalone.redisSecret.secretName }}"
              INSTANCE_NAME="{{ $name }}"

              print_status "Secret: $SECRET_NAME"

              # Check if secret exists
              if kubectl get secret "$SECRET_NAME" -n {{ $root.Release.Namespace }} &> /dev/null; then
                print_status "Found secret: $SECRET_NAME"

                HAS_LABEL=$(kubectl get secret "$SECRET_NAME" -n {{ $root.Release.Namespace }} \
                  -l qs-redis/instance="$INSTANCE_NAME" \
                  -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || echo "")

                if [[ -n "$HAS_LABEL" ]]; then
                  print_status "Deleting secret: $SECRET_NAME"
                  kubectl delete secret "$SECRET_NAME" -n {{ $root.Release.Namespace }}
                  print_success "Deleted secret: $SECRET_NAME"
                  secrets_deleted=$((secrets_deleted + 1))
                else
                  print_warning "Secret '$SECRET_NAME' exists but wasn't created by this chart (missing labels), skipping"
                fi
              else
                print_status "Secret '$SECRET_NAME' not found (may have been deleted already)"
                secrets_not_found=$((secrets_not_found + 1))
              fi
              echo

              {{- end }}

              echo "================================================"
              echo "  Cleanup Summary"
              echo "================================================"
              print_status "  - Deleted: $secrets_deleted"
              print_status "  - Not found: $secrets_not_found"
              echo

              if [ $secrets_deleted -gt 0 ]; then
                print_success "Cleanup complete! $secrets_deleted secret(s) deleted"
              else
                print_status "No secrets were deleted"
              fi

              echo "================================================"
          resources:
            requests:
              memory: "64Mi"
              cpu: "100m"
            limits:
              memory: "128Mi"
              cpu: "500m"
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        fsGroup: 1001
{{- end }}
{{- else }}
---
# Secret cleanup is disabled (secretCleanup.retainOnDelete=true)
# Secrets will be retained after helm uninstall for data recovery
# To enable cleanup, set: secretCleanup.retainOnDelete=false
{{- end }}
