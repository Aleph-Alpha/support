{{- $inst := index .Values "pharia-minio" -}}
{{- if and $inst $inst.enabled }}
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "qs-minio.fullname" . }}-test-bucket-ops
  labels:
    {{- include "qs-minio.labels" . | nindent 4 }}
    helm.sh/chart: {{ include "qs-minio.chart" . }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
    - name: bucket-ops
      image: minio/mc:latest
      imagePullPolicy: IfNotPresent
      env:
        - name: MINIO_ROOT_USER
          valueFrom:
            secretKeyRef:
              name: pharia-minio
              key: root-user
        - name: MINIO_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: pharia-minio
              key: root-password
      command:
        - /bin/sh
        - -ec
        - |
          set -o pipefail

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  MinIO Bucket Operations Test"
          echo "  Instance: pharia-minio"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo

          PASSED=0
          FAILED=0

          echo "ğŸ› ï¸  Setting mc alias"
          if mc alias set local http://pharia-minio:{{ $inst.service.port }} "$MINIO_ROOT_USER" "$MINIO_ROOT_PASSWORD" --api S3v4 >/dev/null 2>&1; then
            echo "  âœ… Alias configured"
            PASSED=$((PASSED+1))
          else
            echo "  âŒ Failed to configure alias"
            FAILED=$((FAILED+1))
          fi

          TEST_BUCKET="helm-test-bucket-$(date +%s)"
          echo "ğŸª£  Test Bucket: $TEST_BUCKET"
          echo "1ï¸âƒ£  Creating bucket"
          if mc mb local/$TEST_BUCKET >/dev/null 2>&1; then
            echo "  âœ… Bucket created"
            PASSED=$((PASSED+1))
          else
            echo "  âŒ Bucket creation failed"
            FAILED=$((FAILED+1))
          fi

          echo "2ï¸âƒ£  Uploading object"
          echo "hello helm" > /tmp/object.txt
          if mc cp /tmp/object.txt local/$TEST_BUCKET/object.txt >/dev/null 2>&1; then
            echo "  âœ… Object uploaded"
            PASSED=$((PASSED+1))
          else
            echo "  âŒ Object upload failed"
            FAILED=$((FAILED+1))
          fi

          echo "3ï¸âƒ£  Verifying object presence"
          if mc stat local/$TEST_BUCKET/object.txt >/dev/null 2>&1; then
            echo "  âœ… Object exists"
            PASSED=$((PASSED+1))
          else
            echo "  âŒ Object missing"
            FAILED=$((FAILED+1))
          fi

          echo "4ï¸âƒ£  Validating object content"
          READBACK=$(mc cat local/$TEST_BUCKET/object.txt 2>/dev/null)
          ORIGINAL=$(cat /tmp/object.txt)
          if [ "$READBACK" = "$ORIGINAL" ]; then
            echo "  âœ… Content matches"
            PASSED=$((PASSED+1))
          else
            echo "  âŒ Content mismatch"
            echo "     Original: $ORIGINAL"
            echo "     Readback: $READBACK"
            FAILED=$((FAILED+1))
          fi

          echo "5ï¸âƒ£  Deleting object"
          if mc rm local/$TEST_BUCKET/object.txt >/dev/null 2>&1; then
            echo "  âœ… Object deleted"
            PASSED=$((PASSED+1))
          else
            echo "  âŒ Failed to delete object"
            FAILED=$((FAILED+1))
          fi

          echo "6ï¸âƒ£  Removing bucket"
          if mc rb --force local/$TEST_BUCKET >/dev/null 2>&1; then
            echo "  âœ… Bucket removed"
            PASSED=$((PASSED+1))
          else
            echo "  âŒ Failed to remove bucket"
            FAILED=$((FAILED+1))
          fi

          echo "7ï¸âƒ£  Confirming bucket removal"
          if mc stat local/$TEST_BUCKET >/dev/null 2>&1; then
            echo "  âŒ Bucket still present"
            FAILED=$((FAILED+1))
          else
            echo "  âœ… Bucket absence confirmed"
            PASSED=$((PASSED+1))
          fi

          echo
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Test Summary"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Steps Passed : $PASSED"
          echo "  Steps Failed : $FAILED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          if [ $FAILED -gt 0 ]; then
            echo "âŒ MinIO bucket operations test failed"
            exit 1
          fi
          echo "âœ… All MinIO bucket operation tests passed"
{{- end }}
