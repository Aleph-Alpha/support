{{- $clusters := dict }}
{{- range .Values.databases }}
{{- if .enabled }}
{{- if not (hasKey $clusters .cluster) }}
{{- $_ := set $clusters .cluster (list) }}
{{- end }}
{{- $dbInfo := dict "name" .name "owner" .owner }}
{{- $_ := set $clusters .cluster (append (get $clusters .cluster) $dbInfo) }}
{{- end }}
{{- end }}
{{- range $clusterName, $databases := $clusters }}
{{- $clusterShortName := trimPrefix "cluster-" $clusterName }}
{{- if gt (len $databases) 1 }}
---
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "qs-postgresql-db.fullname" $ }}-test-isolation-{{ $clusterShortName }}
  labels:
    {{- include "qs-postgresql-db.labels" $ | nindent 4 }}
    app.kubernetes.io/component: test-isolation
    cluster: {{ $clusterName }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
    - name: test-isolation
      image: {{ $.Values.tests.image | default "postgres:17" }}
      imagePullPolicy: IfNotPresent
      env:
        - name: CONNECTION_METHOD
          value: {{ $.Values.tests.connectionMethod | default "direct" | quote }}
        - name: POOLER_MODE
          value: {{ $.Values.tests.poolerMode | default "transaction" | quote }}
        - name: CLUSTER_NAME
          value: "{{ $clusterName }}"
        - name: PGSSLMODE
          value: {{ $.Values.tests.sslMode | default "prefer" | quote }}
        - name: PGCONNECT_TIMEOUT
          value: "3"
      command:
        - /bin/bash
        - -c
        - |
          set -e

          # Determine connection host based on configuration
          if [ "$CONNECTION_METHOD" = "pooler" ]; then
            # Use pooler connection
            if [ "$POOLER_MODE" = "session" ]; then
              # Try to find session pooler
              POOLER_HOST=$(getent hosts "${CLUSTER_NAME}-pooler-${CLUSTER_NAME#cluster-}-rw-session" 2>/dev/null | awk '{print $1}')
              if [ -n "$POOLER_HOST" ]; then
                PGHOST="${CLUSTER_NAME}-pooler-${CLUSTER_NAME#cluster-}-rw-session"
                CONNECTION_TYPE="Native Pooler (Session Mode)"
              else
                echo "âš ï¸  Session pooler not found, falling back to direct connection"
                PGHOST="${CLUSTER_NAME}-rw"
                CONNECTION_TYPE="Direct Cluster (Fallback)"
              fi
            else
              # Try to find transaction pooler
              POOLER_HOST=$(getent hosts "${CLUSTER_NAME}-pooler-${CLUSTER_NAME#cluster-}-rw-transaction" 2>/dev/null | awk '{print $1}')
              if [ -n "$POOLER_HOST" ]; then
                PGHOST="${CLUSTER_NAME}-pooler-${CLUSTER_NAME#cluster-}-rw-transaction"
                CONNECTION_TYPE="Native Pooler (Transaction Mode)"
              else
                echo "âš ï¸  Transaction pooler not found, falling back to direct connection"
                PGHOST="${CLUSTER_NAME}-rw"
                CONNECTION_TYPE="Direct Cluster (Fallback)"
              fi
            fi
          else
            # Use direct connection
            PGHOST="${CLUSTER_NAME}-rw"
            CONNECTION_TYPE="Direct Cluster Access"
          fi

          export PGHOST

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Database Isolation Security Test"
          echo "  Cluster: {{ $clusterName }}"
          echo "  Connection: $CONNECTION_TYPE"
          echo "  Host: $PGHOST"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo

          # Wait for PostgreSQL to be ready
          echo "â³ Waiting for connection endpoint to be ready..."
          MAX_RETRIES=30
          RETRY=0
          until pg_isready -h "$PGHOST" -U postgres || [ $RETRY -eq $MAX_RETRIES ]; do
            echo "   Waiting... (attempt $((RETRY+1))/$MAX_RETRIES)"
            sleep 5
            RETRY=$((RETRY+1))
          done

          if [ $RETRY -eq $MAX_RETRIES ]; then
            echo "âŒ ERROR: Connection endpoint did not become ready in time"
            exit 1
          fi
          echo "âœ… Connection endpoint is ready"
          echo

          FAILED_TESTS=0
          PASSED_TESTS=0
          TOTAL_DATABASES={{ len $databases }}
          SKIPPED_TESTS=0

          {{- $firstDb := index $databases 0 }}
          {{- $secondDb := index $databases 1 }}
          
          # Check if we should skip pgbouncer database when using poolers
          {{- if eq $firstDb.name "pgbouncer" }}
          if [ "$CONNECTION_METHOD" = "pooler" ]; then
            echo "âš ï¸  Note: Skipping isolation tests for pgbouncer database (not accessible via native poolers)"
            echo "   Using next available database for tests..."
            {{- if gt (len $databases) 2 }}
            {{- $firstDb = index $databases 1 }}
            {{- $secondDb = index $databases 2 }}
            echo "   Testing with: {{ $firstDb.name }} and {{ $secondDb.name }}"
            {{- else }}
            echo "   Not enough non-pgbouncer databases to run isolation tests"
            echo "âœ… Skipping isolation tests (only pgbouncer database configured)"
            exit 0
            {{- end }}
            echo
            SKIPPED_TESTS=$((SKIPPED_TESTS + 1))
          fi
          {{- end }}
          
          # Test 1: User from first database trying to access second database
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "Test 1: Cross-Database Access Prevention"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "User: {{ $firstDb.owner }} attempting to access: {{ $secondDb.name }}"
          echo

          {{- if eq $firstDb.name "pgbouncer" }}
          FIRST_PASSWORD=$(cat /secrets/pgbouncer-{{ $clusterShortName }}/password)
          {{- else }}
          FIRST_PASSWORD=$(cat /secrets/{{ $firstDb.name }}/password)
          {{- end }}
          export PGPASSWORD="$FIRST_PASSWORD"

          echo -n "  Attempting connection... "
          OUTPUT=$(psql -h "$PGHOST" -U "{{ $firstDb.owner }}" -d "{{ $secondDb.name }}" -c "SELECT 1;" 2>&1 || true)
          
          if echo "$OUTPUT" | grep -qE "FATAL|ERROR|permission denied"; then
            echo "âœ… PASS: Access correctly denied"
            echo "   $(echo "$OUTPUT" | grep -E 'FATAL|ERROR' | head -1)"
            PASSED_TESTS=$((PASSED_TESTS + 1))
          else
            echo "âŒ FAIL: Access granted (SECURITY ISSUE!)"
            echo "  Output received:"
            echo "$OUTPUT" | head -5 | sed 's/^/    /'
            FAILED_TESTS=$((FAILED_TESTS + 1))
          fi
          echo

          # Test 2: User can access their own database
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "Test 2: Own Database Access Verification"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "User: {{ $firstDb.owner }} accessing own database: {{ $firstDb.name }}"
          echo

          echo -n "  Attempting connection... "
          if psql -h "$PGHOST" -U "{{ $firstDb.owner }}" -d "{{ $firstDb.name }}" -c "SELECT 1;" > /dev/null 2>&1; then
            echo "âœ… PASS: Can access own database"
            PASSED_TESTS=$((PASSED_TESTS + 1))
          else
            echo "âŒ FAIL: Cannot access own database"
            FAILED_TESTS=$((FAILED_TESTS + 1))
          fi
          echo

          # Test 3: Reverse - User from second database trying to access first database
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "Test 3: Reverse Cross-Database Access Prevention"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "User: {{ $secondDb.owner }} attempting to access: {{ $firstDb.name }}"
          echo

          {{- if eq $secondDb.name "pgbouncer" }}
          SECOND_PASSWORD=$(cat /secrets/pgbouncer-{{ $clusterShortName }}/password)
          {{- else }}
          SECOND_PASSWORD=$(cat /secrets/{{ $secondDb.name }}/password)
          {{- end }}
          export PGPASSWORD="$SECOND_PASSWORD"

          echo -n "  Attempting connection... "
          OUTPUT=$(psql -h "$PGHOST" -U "{{ $secondDb.owner }}" -d "{{ $firstDb.name }}" -c "SELECT 1;" 2>&1 || true)
          
          if echo "$OUTPUT" | grep -qE "FATAL|ERROR|permission denied"; then
            echo "âœ… PASS: Access correctly denied"
            echo "   $(echo "$OUTPUT" | grep -E 'FATAL|ERROR' | head -1)"
            PASSED_TESTS=$((PASSED_TESTS + 1))
          else
            echo "âŒ FAIL: Access granted (SECURITY ISSUE!)"
            echo "  Output received:"
            echo "$OUTPUT" | head -5 | sed 's/^/    /'
            FAILED_TESTS=$((FAILED_TESTS + 1))
          fi
          echo

          # Test 4: Second user can access their own database
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "Test 4: Own Database Access Verification (User 2)"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "User: {{ $secondDb.owner }} accessing own database: {{ $secondDb.name }}"
          echo

          echo -n "  Attempting connection... "
          if psql -h "$PGHOST" -U "{{ $secondDb.owner }}" -d "{{ $secondDb.name }}" -c "SELECT 1;" > /dev/null 2>&1; then
            echo "âœ… PASS: Can access own database"
            PASSED_TESTS=$((PASSED_TESTS + 1))
          else
            echo "âŒ FAIL: Cannot access own database"
            FAILED_TESTS=$((FAILED_TESTS + 1))
          fi
          echo

          {{- if gt (len $databases) 2 }}
          # Test all other databases for cross-access (skip firstDb and secondDb already tested above)
          {{- range $idx, $db := $databases }}
          {{- if and (ne $db.name $firstDb.name) (ne $db.name $secondDb.name) }}
          {{- if eq $db.name "pgbouncer" }}
          # Skip pgbouncer database when using poolers
          if [ "$CONNECTION_METHOD" = "pooler" ]; then
            # Skip this test
            :
          else
          {{- end }}
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo "Test {{ add $idx 3 }}: Additional Cross-Database Check"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo "User: {{ $firstDb.owner }} â†’ {{ $db.name }}"
            
            TEST_DB_NAME="{{ $db.name }}"

            export PGPASSWORD="$FIRST_PASSWORD"
            OUTPUT=$(psql -h "$PGHOST" -U "{{ $firstDb.owner }}" -d "$TEST_DB_NAME" -c "SELECT 1;" 2>&1 || true)
            
            if echo "$OUTPUT" | grep -qE "FATAL|ERROR|permission denied"; then
              echo "  âœ… PASS: Cross-access denied"
              PASSED_TESTS=$((PASSED_TESTS + 1))
            else
              echo "  âŒ FAIL: Cross-access granted (SECURITY ISSUE!)"
              echo "  Output received:"
              echo "$OUTPUT" | head -5 | sed 's/^/    /'
              FAILED_TESTS=$((FAILED_TESTS + 1))
            fi
            echo
          {{- if eq $db.name "pgbouncer" }}
          fi
          {{- end }}
          {{- end }}
          {{- end }}
          {{- end }}

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Isolation Test Summary"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  Cluster: {{ $clusterName }}"
          echo "  Connection: $CONNECTION_TYPE"
          echo "  Databases: $TOTAL_DATABASES"
          if [ $SKIPPED_TESTS -gt 0 ]; then
            echo "  Skipped: pgbouncer database (not for native poolers)"
          fi
          echo "  Tests Passed: $PASSED_TESTS"
          echo "  Tests Failed: $FAILED_TESTS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          if [ $FAILED_TESTS -gt 0 ]; then
            echo
            echo "âŒ Database isolation is NOT properly enforced!"
            echo "âš ï¸  Users can access databases they don't own."
            echo "ğŸ’¡ Ensure the isolation enforcement job has run successfully."
            exit 1
          fi

          echo
          echo "âœ… Database isolation is properly enforced!"
          echo "ğŸ”’ Users can only access their own databases."
          if [ "$CONNECTION_METHOD" = "pooler" ]; then
            echo "âœ… Native pooler isolation verified!"
          fi
          exit 0
      volumeMounts:
        {{- range $databases }}
        {{- if eq .name "pgbouncer" }}
        - name: secret-pgbouncer-{{ $clusterShortName }}
          mountPath: /secrets/pgbouncer-{{ $clusterShortName }}
          readOnly: true
        {{- else }}
        - name: secret-{{ .name }}
          mountPath: /secrets/{{ .name }}
          readOnly: true
        {{- end }}
        {{- end }}
  volumes:
    {{- range $databases }}
    {{- if eq .name "pgbouncer" }}
    - name: secret-pgbouncer-{{ $clusterShortName }}
      secret:
        secretName: pgbouncer-{{ $clusterShortName }}-pg-secret-qs
        items:
          - key: password
            path: password
    {{- else }}
    - name: secret-{{ .name }}
      secret:
        secretName: {{ .name }}-pg-secret-qs
        items:
          - key: password
            path: password
    {{- end }}
    {{- end }}
{{- end }}
{{- end }}

