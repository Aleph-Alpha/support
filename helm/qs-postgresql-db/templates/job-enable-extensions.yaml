{{- if .Values.databases }}
{{- $clusters := dict }}
{{- range .Values.databases }}
{{- if and .enabled .extensions }}
{{- if not (hasKey $clusters .cluster) }}
{{- $_ := set $clusters .cluster (list) }}
{{- end }}
{{- $dbInfo := dict "name" .name "extensions" .extensions }}
{{- $_ := set $clusters .cluster (append (get $clusters .cluster) $dbInfo) }}
{{- end }}
{{- end }}
{{- range $clusterName, $databases := $clusters }}
{{- $clusterShortName := trimPrefix "qs-postgresql-cluster-" $clusterName }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "qs-postgresql-db.fullname" $ }}-enable-extensions-{{ $clusterShortName }}
  labels:
    {{- include "qs-postgresql-db.labels" $ | nindent 4 }}
    app.kubernetes.io/component: extension-enabler
    cluster: {{ $clusterName }}
    {{- with $.Values.extensionJob.extraLabels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
    {{- with $.Values.extensionJob.extraAnnotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 5
  template:
    metadata:
      labels:
        {{- include "qs-postgresql-db.selectorLabels" $ | nindent 8 }}
        app.kubernetes.io/component: extension-enabler
        {{- with $.Values.extensionJob.podExtraLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      {{- with $.Values.extensionJob.podExtraAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
    spec:
      restartPolicy: OnFailure
      volumes:
        {{- if $.Values.extensionJob.tmpVolume.enabled }}
        - name: tmp
          emptyDir:
            sizeLimit: {{ $.Values.extensionJob.tmpVolume.sizeLimit | default "10Mi" }}
        {{- end }}
        {{- with $.Values.extensionJob.extraVolumes }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      containers:
        - name: enable-extensions
          image: {{ $.Values.extensionJob.image | default "postgres:17" }}
          imagePullPolicy: IfNotPresent
          {{- with $.Values.extensionJob.securityContext }}
          securityContext:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          volumeMounts:
            {{- if $.Values.extensionJob.tmpVolume.enabled }}
            - name: tmp
              mountPath: /tmp
            {{- end }}
            {{- with $.Values.extensionJob.extraVolumeMounts }}
            {{- toYaml . | nindent 12 }}
            {{- end }}
          env:
            - name: PGHOST
              value: "{{ $clusterName }}-rw"
            - name: PGUSER
              value: "postgres"
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: "{{ $clusterName }}-superuser"
                  key: password
            - name: PGSSLMODE
              value: {{ $.Values.extensionJob.sslMode | default "prefer" | quote }}
          command:
            - /bin/bash
            - -c
            - |
              set -e

              echo "Waiting for PostgreSQL cluster to be ready..."
              MAX_RETRIES=30
              RETRY=0
              until pg_isready -h $PGHOST -U $PGUSER || [ $RETRY -eq $MAX_RETRIES ]; do
                echo "PostgreSQL is not ready yet. Waiting... (attempt $((RETRY+1))/$MAX_RETRIES)"
                sleep 10
                RETRY=$((RETRY+1))
              done

              if [ $RETRY -eq $MAX_RETRIES ]; then
                echo "ERROR: PostgreSQL cluster did not become ready in time"
                exit 1
              fi

              echo "PostgreSQL is ready!"
              echo ""

              # Process each database
              {{- range $databases }}
              echo "========================================"
              echo "Processing database: {{ .name }}"
              echo "========================================"
              export PGDATABASE="{{ .name }}"

              # Check if database exists
              if psql -lqt | cut -d \| -f 1 | grep -qw "{{ .name }}"; then
                echo "Database exists, enabling extensions..."
                {{- range .extensions }}
                echo "  - Enabling extension: {{ . }}"
                if psql -c "CREATE EXTENSION IF NOT EXISTS \"{{ . }}\";" 2>&1 | tee /tmp/ext_output; then
                  echo "    ✓ Success"
                else
                  echo "    ⚠ Warning: Could not create {{ . }}"
                  cat /tmp/ext_output
                fi
                {{- end }}
              else
                echo "⚠ Database {{ .name }} does not exist yet, skipping..."
              fi
              echo ""
              {{- end }}

              echo "========================================"
              echo "Extension enablement complete!"
              echo "========================================"
{{- end }}
{{- end }}
